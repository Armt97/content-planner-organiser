<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
</head>
<body>
  <!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark bg-opacity-75 py-3 position-relative">
  <div class="container-fluid justify-content-center">
    <ul class="navbar-nav">
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/idea-board' %}active{% endif %}" href="{{ url_for('idea_board') }}">Idea-Board</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/calendar' %}active{% endif %}" href="{{ url_for('calendar') }}">Calendar</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/library' %}active{% endif %}" href="{{ url_for('library') }}">Library</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/insights' %}active{% endif %}" href="{{ url_for('insights') }}">Insights</a>
      </li>
    </ul>
  </div>

  <!-- Logout pinned to navbar -->
  <form id="logoutForm" action="/logout" method="post"
        class="position-absolute top-50 end-0 translate-middle-y me-4">
    <button type="submit" class="btn btn-outline-light btn-sm px-3 py-1" id="logoutBtn">
      Logout
    </button>
  </form>
</nav>

  <script>
    const lf = document.getElementById("logoutForm");
    lf?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const res = await fetch("/logout", { method: "POST" });
      const data = await res.json().catch(()=>({}));
      if (data && data.ok) {
        window.location.href = data.redirect || "/";
      } else {
        alert("Logout failed. Try again.");
      }
    });
  </script>

  <!-- Calendar Section -->
  <div class="container py-5">
    <div id="calendar"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      let __visionaDragCleanup = null;

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: ''
        },
        navLinks: false,
        expandRows: false,
        aspectRatio: 1.0,
        eventDisplay: 'block',
        dayMaxEvents: 3,
        fixedWeekCount: true,
        editable: true,
eventStartEditable: true,
eventDurationEditable: false,

eventDragStart(info) {
  requestAnimationFrame(() => {
    const mirror = document.querySelector('.fc-event-mirror');
    if (!mirror) return;

    // Where inside the card was it grabbed?
    const r = mirror.getBoundingClientRect();
    const grabDX = (info.jsEvent.pageX - window.scrollX) - r.left;
    const grabDY = (info.jsEvent.pageY - window.scrollY) - r.top;

    const onMove = (e) => {
      const px = e.pageX - grabDX;   // page-space target left
      const py = e.pageY - grabDY;   // page-space target top

      // Schedule after FC updates its own transform
      requestAnimationFrame(() => {
        mirror.style.setProperty(
          'transform',
          `translate(${px}px, ${py}px)`,
          'important'
        );
      });
    };

    // keep updating while dragging
    document.addEventListener('pointermove', onMove, { passive: true });

    __visionaDragCleanup = () => {
      document.removeEventListener('pointermove', onMove);
      // let FC resume normal control
      mirror.style.removeProperty('transform');
      __visionaDragCleanup = null;
    };
  });
},

eventDragStop() {
  if (typeof __visionaDragCleanup === 'function') __visionaDragCleanup();
},




        // Fetch only Scheduled + Posted events from backend
        events: async function(fetchInfo, successCallback, failureCallback) {
          try {
            const res = await fetch('/api/calendar-events');
            const data = await res.json();
            if (res.ok && data.ok) {
              successCallback(data.events || []);
            } else {
              failureCallback(new Error(data?.message || 'Failed to load events'));
            }
          } catch (err) {
            failureCallback(err);
          }
        },

        // Make the event use its thumbnail as the background
        eventDidMount: function(info) {
  const url = info.event.extendedProps?.thumbnail_url || '';
  if (url) {
    info.el.classList.add('fc-has-thumb');
    info.el.style.backgroundImage = `url("${url.replace(/"/g, '\\"')}")`;
  } else {
    info.el.classList.add('fc-no-thumb');
  }

  const title = info.event.title || '';
  const platform = info.event.extendedProps?.platform || '';
  const status = info.event.extendedProps?.status || '';
  const details = info.event.extendedProps?.details || '';

  // ✅ new status color logic
  const badgeClass =
    status === 'Posted'
      ? 'status-posted'
      : status === 'Scheduled'
      ? 'status-scheduled'
      : 'status-other';

  // create overlay
  const wrap = document.createElement('div');
  wrap.className = 'fc-thumb-overlay';
  wrap.innerHTML = `
    <div class="fc-thumb-topline">
      <span class="fc-thumb-platform badge ${badgeClass}">${platform} • ${status}</span>
    </div>
    <div class="fc-thumb-title">${title}</div>
  `;

  info.el.innerHTML = '';
  info.el.appendChild(wrap);

  if (details) info.el.title = details;
},

        // Click: (optional) jump to Idea-Board for editing
        eventClick: function(info) {
          // If you later add an edit modal here, hook it up.
          // For now, just open the Idea-Board so user can edit there.
          window.location.href = "{{ url_for('idea_board') }}";
        }
      });

      calendar.render();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
