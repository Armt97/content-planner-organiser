<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Idea-Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

<!-- Toast container centered at top -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080">
  <div id="flashToast" class="toast align-items-center text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div id="flashToastBody" class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark bg-opacity-75 py-3">
  <div class="container-fluid justify-content-center">
    <ul class="navbar-nav">
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/idea-board' %}active{% endif %}" href="{{ url_for('idea_board') }}">Idea-Board</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/calendar' %}active{% endif %}" href="{{ url_for('calendar') }}">Calendar</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/library' %}active{% endif %}" href="{{ url_for('library') }}">Library</a>
      </li>
      <li class="nav-item mx-3">
        <a class="nav-link text-white {% if request.path == '/insights' %}active{% endif %}" href="{{ url_for('insights') }}">Insights</a>
      </li>
    </ul>
  </div>
</nav>

<form id="logoutForm" action="/logout" method="post" class="logout-btn">
  <button type="submit" class="btn btn-outline-light btn-sm" style="backdrop-filter:blur(6px);border:1px solid #fff;">
    Logout
  </button>
</form>

<script>
  const lf = document.getElementById("logoutForm");
  lf?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const res = await fetch("/logout", { method: "POST" });
    const data = await res.json().catch(()=>({}));
    if (data && data.ok) {
      window.location.href = data.redirect || "/";
    } else {
      alert("Logout failed. Try again.");
    }
  });
</script>

<!-- Idea Board Section -->
<div class="container py-5">
  <!-- Add Idea form -->
  <form id="addIdeaForm" class="bg-dark bg-opacity-75 text-white p-3 rounded-3 mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="ideaTitle">Title</label>
        <input class="form-control" id="ideaTitle" name="title" placeholder="Reel: Morning Routine" required>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="ideaPlatform">Platform</label>
        <select class="form-select" id="ideaPlatform" name="platform" required>
          <option value="" selected disabled>Choose…</option>
          <option>Instagram</option>
          <option>TikTok</option>
          <option>YouTube</option>
          <option>Facebook</option>
          <option>X</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="ideaWhen">Date & Time</label>
        <input class="form-control" id="ideaWhen" name="scheduled_time" placeholder="Pick a date/time" required>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="ideaStatus">Status</label>
        <select class="form-select" id="ideaStatus" name="status">
          <option>Idea</option>
          <option>In Progress</option>
          <option>Scheduled</option>
          <option>Posted</option>
        </select>
      </div>
    </div>

    <!-- Details -->
    <div class="mt-3">
      <label class="form-label" for="ideaDetails">Details</label>
      <textarea class="form-control" id="ideaDetails" name="details" rows="2" placeholder="What the post will be about…"></textarea>
    </div>

    <!-- Thumbnail: device upload OR URL -->
    <div class="mt-3">
      <label class="form-label" for="ideaThumbFile">Thumbnail (Upload from device)</label>
      <input class="form-control" type="file" id="ideaThumbFile" accept="image/*">
      <label class="form-label mt-2" for="ideaThumb">(Or paste a URL)</label>
      <input class="form-control mt-2" id="ideaThumb" name="thumbnail_url" placeholder="https://example.com/image.jpg">
      <img id="ideaThumbPreview" class="mt-2 rounded" style="max-width:100%; display:none;" alt="Preview">
    </div>

    <!-- Add button -->
    <div class="mt-4 text-center">
      <button class="btn btn-add-idea px-5" type="submit">Add</button>
    </div>
  </form>

  <div class="row">
    <!-- Column: Ideas -->
    <div class="col-md-3">
      <div class="card bg-dark bg-opacity-75 text-white mb-3">
        <div class="card-header text-center">Ideas</div>
        <div id="col-idea" class="card-body d-grid gap-2"></div>
      </div>
    </div>

    <!-- Column: In Progress -->
    <div class="col-md-3">
      <div class="card bg-dark bg-opacity-75 text-white mb-3">
        <div class="card-header text-center">In Progress</div>
        <div id="col-inprogress" class="card-body d-grid gap-2"></div>
      </div>
    </div>

    <!-- Column: Scheduled -->
    <div class="col-md-3">
      <div class="card bg-dark bg-opacity-75 text-white mb-3">
        <div class="card-header text-center">Scheduled</div>
        <div id="col-scheduled" class="card-body d-grid gap-2"></div>
      </div>
    </div>

    <!-- Column: Posted -->
    <div class="col-md-3">
      <div class="card bg-dark bg-opacity-75 text-white mb-3">
        <div class="card-header text-center">Posted</div>
        <div id="col-posted" class="card-body d-grid gap-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editIdeaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Edit Idea</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editIdeaForm" class="row g-3">
          <input type="hidden" id="editId">
          <div class="col-12">
            <label class="form-label" for="editTitle">Title</label>
            <input class="form-control" id="editTitle" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="editPlatform">Platform</label>
            <select class="form-select" id="editPlatform" required>
              <option>Instagram</option><option>TikTok</option><option>YouTube</option><option>Facebook</option><option>X</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="editWhen">Date & Time</label>
            <input class="form-control" id="editWhen" placeholder="Pick a date/time" required>
          </div>
          <div class="col-12">
            <label class="form-label" for="editStatus">Status</label>
            <select class="form-select" id="editStatus">
              <option>Idea</option><option>In Progress</option><option>Scheduled</option><option>Posted</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label" for="editDetails">Details</label>
            <textarea class="form-control" id="editDetails" rows="3" placeholder="What the post will be about…"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label" for="editThumbFile">Thumbnail (Upload from device)</label>
            <input class="form-control" type="file" id="editThumbFile" accept="image/*">
            <label class="form-label mt-2" for="editThumb">(Or paste a URL)</label>
            <input class="form-control mt-2" id="editThumb" placeholder="https://example.com/image.jpg">
            <img id="editThumbPreview" class="mt-2 rounded" style="max-width:100%; display:none;" alt="Preview">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="saveEditBtn" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  // --- Map status <-> column id ---
  const colMap = { "Idea":"col-idea","In Progress":"col-inprogress","Scheduled":"col-scheduled","Posted":"col-posted" };
  const statusFromColId = { "col-idea":"Idea","col-inprogress":"In Progress","col-scheduled":"Scheduled","col-posted":"Posted" };

  // --- Helpers ---
  function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

  // --- Card factory (shows image + details + Edit + top-right X) ---
  function makeIdeaCard(item) {
    const div = document.createElement("div");
    div.className = "card bg-light text-dark p-2 position-relative";
    div.dataset.id = item.id;
    div.draggable = true;

    const when = new Date(item.scheduled_time).toLocaleString();
    const details = (item.details || "").trim();
    const thumb = (item.thumbnail_url || "").trim();

    div.innerHTML = `
      <button type="button" class="btn btn-sm btn-delete position-absolute top-0 end-0 m-1" data-id="${item.id}">×</button>
      ${thumb ? `<img src="${escapeHtml(thumb)}" alt="thumb" class="idea-thumb mb-2">` : ""}
      <div class="fw-semibold">${escapeHtml(item.title)}</div>
      <div class="small text-muted mb-1">${escapeHtml(item.platform)} • ${when}</div>
      ${details ? `<div class="small mb-2">${escapeHtml(details)}</div>` : ""}
      <button type="button" class="btn btn-sm btn-edit" data-id="${item.id}">Edit</button>
    `;

    // buttons
    div.querySelector(".btn-edit").addEventListener("click", (e) => { e.stopPropagation(); openEditModal(item); });
    div.querySelector(".btn-delete").addEventListener("click", async (e) => {
      e.preventDefault(); e.stopPropagation();
      const id = e.currentTarget.dataset.id;
      const res = await fetch(`/api/ideas/${id}`, { method: "DELETE" });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.ok) div.remove(); else alert(data?.message || "Failed to delete idea.");
    });

    // drag n drop
    div.addEventListener("dragstart", (e) => {
      div.classList.add("dragging");
      e.dataTransfer.setData("text/plain", String(item.id));
      e.dataTransfer.effectAllowed = "move";
      if (e.dataTransfer.setDragImage) {
        const ghost = document.createElement("div");
        ghost.className = "p-1 bg-light border rounded text-dark";
        ghost.style.position = "absolute";
        ghost.style.top = "-9999px";
        ghost.textContent = item.title;
        document.body.appendChild(ghost);
        e.dataTransfer.setDragImage(ghost, 0, 0);
        setTimeout(() => ghost.remove(), 0);
      }
    });
    div.addEventListener("dragend", () => div.classList.remove("dragging"));

    return div;
  }

  async function updateStatus(id, newStatus) {
    const res = await fetch(`/api/ideas/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus })
    });
    const data = await res.json().catch(()=>({}));
    return !!(res.ok && data.ok);
  }

  function wireDropZones() {
    Object.values(colMap).forEach((colId) => {
      const zone = document.getElementById(colId);
      if (!zone) return;

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        zone.classList.add("dnd-over");
      });

      zone.addEventListener("dragleave", () => zone.classList.remove("dnd-over"));

      zone.addEventListener("drop", async (e) => {
        e.preventDefault();
        zone.classList.remove("dnd-over");

        const id = e.dataTransfer.getData("text/plain");
        if (!id) return;

        const newStatus = statusFromColId[colId];
        if (!newStatus) return;

        const card = document.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
        if (card?.parentElement?.id === colId) return;

        const ok = await updateStatus(id, newStatus);
        if (ok) { if (card) zone.appendChild(card); }
        else { alert("Could not move card. Try again."); }
      });
    });
  }

  async function loadIdeas() {
    Object.values(colMap).forEach((id) => { const el = document.getElementById(id); if (el) el.innerHTML = ""; });

    const res = await fetch("/api/ideas");
    const data = await res.json().catch(() => ({ ok:false, items:[] }));
    if (!data.ok) return;

    data.items.forEach((item) => {
      const colId = colMap[item.status] || colMap["Idea"];
      const colEl = document.getElementById(colId);
      if (colEl) colEl.appendChild(makeIdeaCard(item));
    });
  }

  // --- Flatpickr + previews + wiring ---
  let fpIdeaWhen, fpEditWhen, editModal;

  document.addEventListener("DOMContentLoaded", () => {
    fpIdeaWhen = flatpickr("#ideaWhen", {
      enableTime: true, time_24hr: false, minuteIncrement: 5,
      altInput: true, altFormat: "D, d M Y h:i K",
      dateFormat: "Z", defaultHour: 12, allowInput: false
    });

    fpEditWhen = flatpickr("#editWhen", {
      enableTime: true, time_24hr: false, minuteIncrement: 5,
      altInput: true, altFormat: "D, d M Y h:i K",
      dateFormat: "Z", defaultHour: 12, allowInput: false
    });

    // Add preview
    const ideaThumbFile = document.getElementById("ideaThumbFile");
    const ideaThumbPreview = document.getElementById("ideaThumbPreview");
    ideaThumbFile?.addEventListener("change", () => {
      const f = ideaThumbFile.files?.[0];
      if (f) {
        const reader = new FileReader();
        reader.onload = () => { ideaThumbPreview.src = reader.result; ideaThumbPreview.style.display = "block"; };
        reader.readAsDataURL(f);
      } else { ideaThumbPreview.src = ""; ideaThumbPreview.style.display = "none"; }
    });

    // Edit preview
    const editThumbFile = document.getElementById("editThumbFile");
    const editThumbPreview = document.getElementById("editThumbPreview");
    editThumbFile?.addEventListener("change", () => {
      const f = editThumbFile.files?.[0];
      if (f) {
        const reader = new FileReader();
        reader.onload = () => { editThumbPreview.src = reader.result; editThumbPreview.style.display = "block"; };
        reader.readAsDataURL(f);
      } else { editThumbPreview.src = ""; editThumbPreview.style.display = "none"; }
    });

    editModal = new bootstrap.Modal(document.getElementById("editIdeaModal"));
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

    const addForm = document.getElementById("addIdeaForm");
    addForm?.addEventListener("submit", handleAddIdea);

    wireDropZones();
    loadIdeas();
  });

  // Upload helper (used by Add & Edit)
  async function uploadThumbnail(fileInput) {
    const file = fileInput.files?.[0];
    if (!file) return null;

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/api/upload-image", { method: "POST", body: formData });
      const data = await res.json();
      if (data.ok) return data.url;
      alert(data.message || "Upload failed.");
    } catch (err) {
      alert("Network error during upload.");
    }
    return null;
  }

  // Create Idea
  async function handleAddIdea(e) {
    e.preventDefault();
    const titleEl    = document.getElementById("ideaTitle");
    const platformEl = document.getElementById("ideaPlatform");
    const whenEl     = document.getElementById("ideaWhen");
    const statusEl   = document.getElementById("ideaStatus");
    const detailsEl  = document.getElementById("ideaDetails");
    const thumbUrlEl = document.getElementById("ideaThumb");
    const thumbFileEl= document.getElementById("ideaThumbFile");

    const fp = fpIdeaWhen || whenEl?._flatpickr;
    if (!fp || !fp.selectedDates || !fp.selectedDates[0]) { alert("Please pick a date and time."); return; }
    const iso = fp.selectedDates[0].toISOString();

    // Upload file first (if chosen) to get a URL
    let finalThumbUrl = (thumbUrlEl?.value || "").trim();
    const chosenFile = thumbFileEl?.files?.[0];
    if (chosenFile) {
      const fd = new FormData();
      fd.append("file", chosenFile);
      const upRes = await fetch("/api/upload-image", { method: "POST", body: fd });
      const upData = await upRes.json().catch(()=>({}));
      if (upRes.ok && upData?.ok && upData.url) {
        finalThumbUrl = upData.url;
      } else {
        alert(upData?.message || "Image upload failed.");
        return;
      }
    }

    // Create the idea
    let res, data;
    try {
      res = await fetch("/api/ideas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: titleEl.value.trim(),
          platform: platformEl.value,
          scheduled_time: iso,
          status: statusEl.value,
          details: (detailsEl.value || "").trim(),
          thumbnail_url: finalThumbUrl
        })
      });
      data = await res.json().catch(() => ({}));
    } catch (err) {
      console.error("Network error:", err);
      alert("Network error while adding the idea.");
      return;
    }

    if (res.ok && data?.ok) {
      document.getElementById("addIdeaForm").reset();
      const ideaThumbPreview = document.getElementById("ideaThumbPreview");
      if (ideaThumbPreview) { ideaThumbPreview.src=""; ideaThumbPreview.style.display="none"; }
      fp.clear();
      await loadIdeas();
    } else {
      console.error("Add idea error:", data);
      alert(data?.message || "Failed to add. Please check your inputs.");
    }
  }

  // Edit modal wiring
  function openEditModal(item) {
    document.getElementById("editId").value = item.id;
    document.getElementById("editTitle").value = item.title;
    document.getElementById("editPlatform").value = item.platform;
    document.getElementById("editStatus").value = item.status;
    document.getElementById("editDetails").value = item.details || "";
    document.getElementById("editThumb").value = item.thumbnail_url || "";
    const editThumbPreview = document.getElementById("editThumbPreview");
    if (item.thumbnail_url) { editThumbPreview.src = item.thumbnail_url; editThumbPreview.style.display = "block"; }
    else { editThumbPreview.src = ""; editThumbPreview.style.display = "none"; }
    fpEditWhen.setDate(new Date(item.scheduled_time), true);
    editModal.show();
  }

  // Save Edit
  async function saveEdit() {
    const id        = document.getElementById("editId").value;
    const title     = document.getElementById("editTitle").value.trim();
    const platform  = document.getElementById("editPlatform").value;
    const status    = document.getElementById("editStatus").value;
    const details   = (document.getElementById("editDetails").value || "").trim();
    const editUrlEl = document.getElementById("editThumb");
    const editFileEl= document.getElementById("editThumbFile");

    if (!fpEditWhen || !fpEditWhen.selectedDates[0]) { alert("Please pick a date and time."); return; }
    const iso = fpEditWhen.selectedDates[0].toISOString();

    // Upload new file if selected
    let finalThumbUrl = (editUrlEl?.value || "").trim();
    const editChosenFile = editFileEl?.files?.[0];
    if (editChosenFile) {
      const fd = new FormData();
      fd.append("file", editChosenFile);
      const upRes = await fetch("/api/upload-image", { method: "POST", body: fd });
      const upData = await upRes.json().catch(()=>({}));
      if (upRes.ok && upData?.ok && upData.url) {
        finalThumbUrl = upData.url;
      } else {
        alert(upData?.message || "Image upload failed.");
        return;
      }
    }

    let res, data;
    try {
      res = await fetch(`/api/ideas/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, platform, status, details, scheduled_time: iso, thumbnail_url: finalThumbUrl })
      });
      data = await res.json().catch(()=>({}));
    } catch {
      alert("Network error while saving."); return;
    }

    if (res.ok && data?.ok) {
      editModal.hide();
      await loadIdeas();
    } else {
      alert(data?.message || "Failed to save changes.");
    }
  }
</script>

</body>
</html>
